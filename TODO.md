# Ponte — TODO

## Аудио-мост через Raspberry Pi (Bluetooth HFP)

**Статус:** запланировано, не начато

### Проблема

Android не позволяет обычным приложениям (без рута):
- Захватывать аудио сотового звонка (`CAPTURE_AUDIO_OUTPUT` — системное разрешение)
- Инжектить аудио в аплинк звонка (управляется модемом, закрыто на уровне ОС)

Единственный способ получить двустороннее аудио — подключить телефон к внешнему устройству как к Bluetooth-гарнитуре (профиль HFP). Так делает Microsoft Phone Link.

### Решение

Raspberry Pi рядом с телефоном (Samsung A31), подключённая по Bluetooth как HFP-гарнитура. Pi получает аудио звонка и передаёт его на веб через WebSocket. Микрофон с веба идёт обратно через Pi в звонок.

### Схема

```
Собеседник ↔ Сотовая сеть ↔ Android (BT HFP) ↔ Raspberry Pi (BlueZ + PipeWire) ↔ WebSocket ↔ Браузер
```

- **Даунлинк** (слышать собеседника): Телефон → BT HFP → Pi → PipeWire захват → WebSocket → браузер (Web Audio API)
- **Аплинк** (говорить в звонок): Браузер (getUserMedia) → WebSocket → Pi → PipeWire воспроизведение → BT HFP → Телефон → собеседник

### Железо

- **Raspberry Pi Zero 2W** (~2500р на Авито) — Bluetooth встроен, хватит для аудио-стриминга
- Или любой другой Pi с Bluetooth (3B+, 4, 5)
- Pi подключается к той же локальной сети, что и веб-сервер (Wi-Fi или Ethernet через USB-адаптер)

### Софт на Pi

```bash
# Базовые пакеты
sudo apt install bluez pipewire pipewire-audio bluez-tools

# Спаривание: Pi поднимает HFP профиль, телефон видит Pi как гарнитуру
bluetoothctl
# > power on
# > agent on
# > default-agent
# > discoverable on
# > pairable on
# Samsung находит Pi, спаривается
```

PipeWire захватывает BT аудио поток → Node.js сервер на Pi читает через ALSA/pactl → шлёт по WebSocket на backend Ponte → браузер.

### Стек

1. **BlueZ** — Bluetooth стек Linux, управление HFP профилем
2. **PipeWire** — аудио-сервер, маршрутизация BT аудио в виртуальные устройства
3. **Node.js процесс на Pi** (или скрипт) — читает PCM из PipeWire, стримит по WebSocket
4. **Backend Ponte** — проксирует аудио-поток между Pi и браузером
5. **Браузер** — Web Audio API для воспроизведения даунлинка, getUserMedia для захвата микрофона (аплинка)

### Известные сложности

- **BlueZ HFP — боль.** Много нюансов с профилями, кодеками (mSBC vs CVSD), Samsung часто капризничает с BT подключениями
- **Кодеки:** mSBC (16kHz, лучше качество) vs CVSD (8kHz, стандарт). Нужно проверить что Samsung A31 поддерживает
- **Латентность:** BT HFP + WebSocket + Web Audio = нужно замерить, насколько приемлема задержка для разговора
- **Автоподключение:** Pi должна автоматически подключаться к телефону как гарнитура при входящем/исходящем звонке
- **Переключение аудио на Android:** при звонке Android должен направить аудио на BT-гарнитуру (Pi), а не на динамик. Может потребоваться управление через InCallService (setAudioRoute)

### Шаги реализации

1. [ ] Купить Raspberry Pi Zero 2W (или аналог)
2. [ ] Настроить BlueZ + PipeWire на Pi, поднять HFP профиль
3. [ ] Спарить Pi с Samsung A31, добиться стабильного BT HFP соединения
4. [ ] Написать скрипт/сервис на Pi для захвата аудио из PipeWire и стриминга по WebSocket
5. [ ] Добавить в backend Ponte эндпоинт/WebSocket для аудио-потока с Pi
6. [ ] В Android-приложении: при звонке автоматически переключать аудио на BT-гарнитуру (`setAudioRoute(CallAudioState.ROUTE_BLUETOOTH)`)
7. [ ] На вебе: принимать аудио-поток, воспроизводить через Web Audio API
8. [ ] На вебе: захватывать микрофон (getUserMedia), отправлять по WebSocket → Pi → BT HFP → звонок
9. [ ] Тестировать латентность, качество, стабильность
10. [ ] Автозапуск сервиса на Pi при загрузке