name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  check-release:
    name: Check release trigger
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check.outputs.release }}
    steps:
      - id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]] || [[ "$COMMIT_MSG" == *"!release"* ]]; then
            echo "release=true" >> "$GITHUB_OUTPUT"
          else
            echo "release=false" >> "$GITHUB_OUTPUT"
          fi

  backend-docker:
    name: Backend Docker
    needs: check-release
    if: needs.check-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: backend
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/ponte-backend:latest
            ghcr.io/${{ github.repository }}/ponte-backend:${{ github.sha }}

  web-docker:
    name: Web Docker
    needs: check-release
    if: needs.check-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: web
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/ponte-web:latest
            ghcr.io/${{ github.repository }}/ponte-web:${{ github.sha }}

  android-release:
    name: Android Release
    needs: check-release
    if: needs.check-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: android
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: gradle/actions/setup-gradle@v4

      - name: Build release APK
        run: ./gradlew assembleRelease

      - name: Sign APK
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > keystore.jks
          "$ANDROID_HOME/build-tools/$(ls "$ANDROID_HOME/build-tools/" | tail -1)/apksigner" sign \
            --ks keystore.jks \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass "pass:$STORE_PASSWORD" \
            --key-pass "pass:$KEY_PASSWORD" \
            app/build/outputs/apk/release/app-release-unsigned.apk
          mv app/build/outputs/apk/release/app-release-unsigned.apk app/build/outputs/apk/release/ponte-release.apk
          rm keystore.jks

      - uses: actions/upload-artifact@v4
        with:
          name: ponte-apk
          path: android/app/build/outputs/apk/release/ponte-release.apk

  create-release:
    name: Create Release
    needs: [backend-docker, web-docker, android-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: ponte-apk
          path: artifacts

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v$(date +'%Y.%m.%d-%H%M')"
          gh release create "$TAG" \
            --title "Release $TAG" \
            --generate-notes \
            artifacts/ponte-release.apk
