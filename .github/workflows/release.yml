name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  check-release:
    name: Check release trigger
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check.outputs.release }}
    steps:
      - id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]] || [[ "$COMMIT_MSG" == *"!release"* ]]; then
            echo "release=true" >> "$GITHUB_OUTPUT"
          else
            echo "release=false" >> "$GITHUB_OUTPUT"
          fi

  version:
    name: Calculate version
    needs: check-release
    if: needs.check-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: bump
        env:
          EVENT_NAME: ${{ github.event_name }}
          VERSION_INPUT: ${{ github.event.inputs.version_type }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          # Determine release type
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            TYPE="$VERSION_INPUT"
          else
            TYPE=$(echo "$COMMIT_MSG" | grep -oP '!release:\s*\K(major|minor|patch)' || echo "patch")
          fi

          # Get last tag, default to 0.0.0
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          LAST_VERSION="${LAST_TAG#v}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$LAST_VERSION"
          MAJOR=${MAJOR:-0}; MINOR=${MINOR:-0}; PATCH=${PATCH:-0}

          case "$TYPE" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Calculated version: $VERSION (type: $TYPE, previous: $LAST_VERSION)"

  backend-docker:
    name: Backend Docker
    needs: [check-release, version]
    if: needs.check-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REPO: ${{ github.repository }}
      VERSION: ${{ needs.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        run: |
          REPO_LC="${REPO,,}"
          IMAGE="ghcr.io/${REPO_LC}/ponte-backend"
          docker build \
            -t "${IMAGE}:latest" \
            -t "${IMAGE}:${VERSION}" \
            -t "${IMAGE}:${{ github.sha }}" \
            backend
          docker push "${IMAGE}:latest"
          docker push "${IMAGE}:${VERSION}"
          docker push "${IMAGE}:${{ github.sha }}"

  web-docker:
    name: Web Docker
    needs: [check-release, version]
    if: needs.check-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REPO: ${{ github.repository }}
      VERSION: ${{ needs.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        run: |
          REPO_LC="${REPO,,}"
          IMAGE="ghcr.io/${REPO_LC}/ponte-web"
          docker build \
            -t "${IMAGE}:latest" \
            -t "${IMAGE}:${VERSION}" \
            -t "${IMAGE}:${{ github.sha }}" \
            web
          docker push "${IMAGE}:latest"
          docker push "${IMAGE}:${VERSION}"
          docker push "${IMAGE}:${{ github.sha }}"

  android-release:
    name: Android Release
    needs: [check-release, version]
    if: needs.check-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: android
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: gradle/actions/setup-gradle@v4

      - name: Update version
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          VERSION_CODE=$(( MAJOR * 10000 + MINOR * 100 + PATCH ))
          sed -i "s/versionCode = .*/versionCode = $VERSION_CODE/" app/build.gradle.kts
          sed -i "s/versionName = .*/versionName = \"$VERSION\"/" app/build.gradle.kts

      - name: Build release APK
        run: ./gradlew assembleRelease

      - name: Sign APK
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          if [[ -z "$KEYSTORE_BASE64" ]]; then
            echo "::error::Missing signing secrets. Set KEYSTORE_BASE64, KEY_ALIAS, KEY_PASSWORD, STORE_PASSWORD in repo secrets."
            echo "Run ./scripts/android-generate-signing-key.sh to generate them."
            exit 1
          fi

          APK="app/build/outputs/apk/release/app-release-unsigned.apk"
          OUT="app/build/outputs/apk/release/ponte-release.apk"

          echo "$KEYSTORE_BASE64" | base64 -d > /tmp/keystore.jks

          APKSIGNER="$ANDROID_HOME/build-tools/$(ls "$ANDROID_HOME/build-tools/" | sort -V | tail -1)/apksigner"

          "$APKSIGNER" sign \
            --ks /tmp/keystore.jks \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass "pass:$STORE_PASSWORD" \
            --key-pass "pass:$KEY_PASSWORD" \
            --out "$OUT" \
            "$APK"

          "$APKSIGNER" verify "$OUT"
          rm /tmp/keystore.jks

      - uses: actions/upload-artifact@v4
        with:
          name: ponte-apk
          path: android/app/build/outputs/apk/release/ponte-release.apk

  create-release:
    name: Create Release
    needs: [backend-docker, web-docker, android-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/artifacts

      - name: Auto Release
        uses: zxcloli666/release-helper@main
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_TYPE: ${{ github.event.inputs.version_type }}
          BUILD_COMMAND: "echo 'Using pre-built artifacts'"
          ASSET_PATTERNS: "/tmp/artifacts/**/*"
          OPENAI_API_BASE_URL: ${{ secrets.AI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.AI_API_KEY }}
          OPENAI_API_MODEL: deep-think
          LANGUAGE: "üá∑üá∫ –†—É—Å—Å–∫–∏–π"
